<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Geo Kombat ‚Äî Study & Exam</title>
<style>
  :root{
    --bg:#070a12;
    --panel:#0c1120;
    --card:#0f1730;
    --card2:#0b1228;
    --line:rgba(255,255,255,.10);
    --text:#eef1ff;
    --muted:#aeb7df;
    --muted2:#7f89b6;
    --accent:#6a7dff;
    --good:#2cff88;
    --bad:#ff4b67;
    --warn:#ffd166;
    --shadow: 0 18px 60px rgba(0,0,0,.55);
    --radius: 18px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    background: radial-gradient(1000px 600px at 20% 0%, rgba(106,125,255,.18), transparent 60%),
                radial-gradient(900px 520px at 80% 20%, rgba(255,209,102,.12), transparent 60%),
                var(--bg);
    color:var(--text);
    display:flex;
    justify-content:center;
    padding:18px;
  }

  .app{
    width:min(980px, 100%);
    background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08);
    border-radius: 24px;
    box-shadow: var(--shadow);
    overflow:hidden;
  }

  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:16px 16px 10px;
    gap:12px;
  }
  .brand{
    display:flex; align-items:center; gap:10px;
  }
  .logo{
    width:34px; height:34px; border-radius:10px;
    background: linear-gradient(135deg, rgba(106,125,255,.9), rgba(44,255,136,.55));
    display:grid; place-items:center;
    box-shadow: 0 10px 30px rgba(106,125,255,.28);
    font-weight:900;
  }
  .titlewrap .h1{
    font-size:16px; font-weight:800; letter-spacing:.2px;
    line-height:1.1;
  }
  .titlewrap .sub{
    margin-top:4px;
    font-size:12px;
    color:var(--muted);
  }

  .top-actions{
    display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  }

  .btn{
    appearance:none;
    border:none;
    border-radius:999px;
    padding:10px 14px;
    font-weight:800;
    cursor:pointer;
    color:var(--text);
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    transition: transform .12s ease, border-color .12s ease, background .12s ease;
    user-select:none;
    -webkit-tap-highlight-color: transparent;
  }
  .btn:hover{ border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.08) }
  .btn:active{ transform: translateY(1px) }
  .btn.primary{
    background: rgba(106,125,255,.95);
    border-color: rgba(106,125,255,.95);
    color:#0b0e1a;
  }
  .btn.danger{ background: rgba(255,75,103,.14); border-color: rgba(255,75,103,.30) }
  .btn.ghost{ background: transparent; border-color: rgba(255,255,255,.10) }
  .btn.small{ padding:8px 12px; font-size:12px; font-weight:800 }
  .btn:disabled{
    opacity:.45;
    cursor:not-allowed;
    transform:none;
  }

  main{ padding: 0 16px 16px; }
  .row{
    display:flex;
    gap:12px;
    align-items:stretch;
    flex-wrap:wrap;
  }
  .panel{
    background: rgba(12,17,32,.70);
    border:1px solid rgba(255,255,255,.08);
    border-radius: var(--radius);
    padding:14px;
    box-shadow: 0 10px 30px rgba(0,0,0,.28);
  }
  .stats{
    flex: 1 1 290px;
    min-width: 270px;
  }
  .controls{
    flex: 1 1 420px;
    min-width: 300px;
  }
  .kpi{
    display:flex; gap:12px; flex-wrap:wrap;
  }
  .pill{
    display:inline-flex; gap:8px; align-items:center;
    padding:8px 12px;
    border-radius:999px;
    background: rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.08);
    font-size:12px;
    color:var(--muted);
  }
  .pill b{ color:var(--text) }
  .timerBig{
    font-size:44px;
    font-weight:950;
    letter-spacing:-1px;
    color: var(--warn);
    line-height:1;
  }
  .timerLabel{
    font-size:12px;
    color: var(--muted);
    margin-top:6px;
  }

  .control-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    align-items:center;
  }
  @media(max-width:720px){
    .control-grid{ grid-template-columns: 1fr; }
  }

  label{
    font-size:12px;
    color:var(--muted);
    display:block;
    margin-bottom:6px;
  }
  select{
    width:100%;
    padding:10px 12px;
    border-radius:12px;
    background: rgba(255,255,255,.04);
    color:var(--text);
    border:1px solid rgba(255,255,255,.10);
    outline:none;
    font-weight:700;
  }
  option{ background:#0b0e1a; }

  .quiz{
    margin-top:12px;
    background: rgba(12,17,32,.72);
    border:1px solid rgba(255,255,255,.08);
    border-radius: 22px;
    padding:16px;
    position:relative;
    overflow:hidden;
  }
  .quiz::before{
    content:"";
    position:absolute; inset:-2px;
    background: radial-gradient(700px 320px at 30% 0%, rgba(106,125,255,.18), transparent 65%),
                radial-gradient(700px 320px at 70% 20%, rgba(44,255,136,.12), transparent 65%);
    pointer-events:none;
  }
  .quiz > *{ position:relative; }

  .q-top{
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:flex-start;
    flex-wrap:wrap;
  }
  .q-title{
    font-size:20px;
    font-weight:900;
    letter-spacing:.2px;
    margin:0;
  }
  .q-meta{
    margin-top:6px;
    font-size:12px;
    color:var(--muted);
  }
  .q-right{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
  }
  .badge{
    display:inline-flex; gap:8px; align-items:center;
    padding:8px 12px;
    border-radius:999px;
    background: rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.08);
    font-size:12px;
    color:var(--muted);
  }
  .badge b{ color:var(--text) }

  .answers{
    margin-top:14px;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  @media(max-width:720px){
    .answers{ grid-template-columns: 1fr; }
  }
  .ans{
    border-radius: 14px;
    padding: 14px 14px;
    background: rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.10);
    cursor:pointer;
    font-weight:850;
    color:var(--text);
    text-align:left;
    transition: transform .10s ease, border-color .10s ease, background .10s ease;
    user-select:none;
    -webkit-tap-highlight-color: transparent;
  }
  .ans:hover{ border-color: rgba(106,125,255,.55); background: rgba(106,125,255,.08) }
  .ans:active{ transform: translateY(1px) }
  .ans[aria-disabled="true"]{ opacity:.55; cursor:not-allowed }
  .ans.correct{ background: rgba(44,255,136,.10); border-color: rgba(44,255,136,.55) }
  .ans.wrong{ background: rgba(255,75,103,.10); border-color: rgba(255,75,103,.55) }

  .bottom{
    margin-top:14px;
    display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
  }
  .hintbox{
    flex: 1 1 420px;
    min-width: 280px;
    padding: 10px 12px;
    border-radius:14px;
    background: rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.08);
    color:var(--muted);
    font-size:12px;
  }
  .hintbox b{ color:var(--text) }
  .footer-actions{
    display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  }

  .menu{
    padding: 14px;
    display:none;
  }
  .menu.show{ display:block; }
  .menu .grid{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:10px;
  }
  @media(max-width:820px){
    .menu .grid{ grid-template-columns: 1fr; }
  }
  .modeCard{
    background: rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.10);
    border-radius: 18px;
    padding: 14px;
  }
  .modeCard h3{
    margin:0 0 6px;
    font-size:14px;
    font-weight:900;
  }
  .modeCard p{
    margin:0 0 10px;
    color:var(--muted);
    font-size:12px;
    line-height:1.35;
  }

  .screen{
    display:none;
  }
  .screen.show{ display:block; }

  .results{
    margin-top:12px;
    background: rgba(12,17,32,.72);
    border:1px solid rgba(255,255,255,.08);
    border-radius: 22px;
    padding:16px;
  }
  .scoreBig{
    font-size:34px;
    font-weight:950;
    letter-spacing:-.5px;
    margin:0;
  }
  .missList{
    margin-top:10px;
    display:grid;
    gap:10px;
  }
  .missItem{
    border:1px solid rgba(255,255,255,.10);
    border-radius:16px;
    padding:12px;
    background: rgba(255,255,255,.03);
  }
  .missItem .t{ font-weight:900; margin-bottom:6px }
  .missItem .m{ color:var(--muted); font-size:12px; line-height:1.35 }
  .kbd{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    font-size:11px;
    padding:2px 6px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.05);
    color:var(--text);
  }

  .toast{
    position:fixed;
    left:50%;
    transform: translateX(-50%);
    bottom: 16px;
    background: rgba(15,23,48,.92);
    border:1px solid rgba(255,255,255,.12);
    color:var(--text);
    padding:10px 12px;
    border-radius: 14px;
    box-shadow: 0 18px 60px rgba(0,0,0,.55);
    font-size:12px;
    opacity:0;
    pointer-events:none;
    transition: opacity .18s ease, transform .18s ease;
  }
  .toast.show{
    opacity:1;
    transform: translateX(-50%) translateY(-4px);
  }
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="brand">
      <div class="logo">G</div>
      <div class="titlewrap">
        <div class="h1">Geo Kombat</div>
        <div class="sub">Flags ¬∑ Capitals ¬∑ Language ¬∑ Nationality ¬∑ Government ¬∑ Economy (all countries via live dataset)</div>
      </div>
    </div>
    <div class="top-actions">
      <button class="btn small ghost" id="btnMenu">Main Menu</button>
      <button class="btn small ghost" id="btnRestart">Restart</button>
      <button class="btn small" id="btnLifeline" title="Remove two wrong answers (max 3 per run)">Lifeline (<span id="lifelineCount">3</span>)</button>
    </div>
  </header>

  <main>
    <!-- MENU -->
    <section class="menu show" id="menu">
      <div class="row">
        <div class="panel stats">
          <div class="kpi">
            <div class="pill">Countries loaded: <b id="countriesCount">‚Ä¶</b></div>
            <div class="pill">Dataset: <b id="datasetStatus">loading</b></div>
            <div class="pill">Shortcuts: <b><span class="kbd">1</span>‚Äì<span class="kbd">4</span></b></div>
          </div>
          <div style="margin-top:12px;color:var(--muted);font-size:12px;line-height:1.35">
            Aligned to the real test: multiple-choice only, hard distractors, includes multi-language countries and special capital cases (e.g., South Africa).
          </div>
        </div>
        <div class="panel controls">
          <div class="control-grid">
            <div>
              <label for="modeSelect">Game mode</label>
              <select id="modeSelect">
                <option value="study">Study (endless)</option>
                <option value="exam">Exam (choose question count)</option>
                <option value="time">Time Attack (answer as many as possible)</option>
              </select>
            </div>
            <div>
              <label for="examCount">Exam questions</label>
              <select id="examCount">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="30">30</option>
                <option value="40">40</option>
                <option value="60">60</option>
              </select>
            </div>
            <div style="grid-column: 1 / -1; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
              <button class="btn primary" id="btnStart">Start</button>
              <div class="pill">Tip: Lifeline removes 2 wrong answers.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- GAME -->
    <section class="screen" id="game">
      <div class="row">
        <div class="panel stats">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap;">
            <div>
              <div class="pill">Mode: <b id="modeLabel">Study</b></div>
              <div style="height:8px"></div>
              <div class="pill">XP: <b id="xp">0</b></div>
              <div class="pill">Streak: <b id="streak">0</b></div>
              <div class="pill">Accuracy: <b id="acc">‚Äî</b></div>
              <div class="pill" id="examProgPill" style="display:none">Question: <b id="examProg">1/20</b></div>
            </div>
            <div id="timerBox" style="display:none; text-align:right;">
              <div class="timerBig" id="timer">60</div>
              <div class="timerLabel">seconds left</div>
            </div>
          </div>
          <div style="margin-top:12px;color:var(--muted);font-size:12px;line-height:1.35">
            Hard distractors are chosen from similar regions/language families when possible, and duplicates are prevented.
          </div>
        </div>
        <div class="panel controls">
          <div class="kpi">
            <div class="pill">Correct: <b id="correct">0</b></div>
            <div class="pill">Wrong: <b id="wrong">0</b></div>
            <div class="pill">Lifelines left: <b id="lifelineLeft">3</b></div>
          </div>
          <div style="margin-top:12px;color:var(--muted);font-size:12px;line-height:1.35">
            In Time Attack, answer ‚Üí Next to keep speed. In Exam, you‚Äôll get a final score (0‚Äì100) + review.
          </div>
        </div>
      </div>

      <div class="quiz" id="quiz">
        <div class="q-top">
          <div>
            <h2 class="q-title" id="qTitle">Loading‚Ä¶</h2>
            <div class="q-meta" id="qMeta"></div>
          </div>
          <div class="q-right">
            <div class="badge">Target: <b id="qCountry">‚Äî</b></div>
            <div class="badge">Topic: <b id="qTopic">‚Äî</b></div>
          </div>
        </div>

        <div class="answers" id="answers" role="listbox" aria-label="answers"></div>

        <div class="bottom">
          <div class="hintbox" id="hintBox"><b>Hint</b>: Use Lifeline to remove two wrong options (max 3). Shortcuts: <span class="kbd">1</span>‚Äì<span class="kbd">4</span>.</div>
          <div class="footer-actions">
            <button class="btn primary" id="btnNext">Next</button>
          </div>
        </div>
      </div>

      <div class="results" id="results" style="display:none">
        <p class="scoreBig" id="finalScore">Score: 0</p>
        <div style="color:var(--muted); font-size:12px; margin-top:6px" id="finalMeta"></div>
        <div class="missList" id="missList"></div>
      </div>
    </section>
  </main>
</div>

<div class="toast" id="toast"></div>

<script>
/* =========================================================
   Geo Kombat ‚Äî clickable, mobile-safe, exam-aligned
   - All countries loaded from https://restcountries.com/v3.1/all
   - Topics: flags, capitals, language(s), nationality, government (simple), economy examples
   - Multiple choice only, hard distractors, no duplicates
   - Lifeline removes two wrong answers (max 3)
   - Modes: Study, Exam (choose count), Time Attack
   ========================================================= */

(() => {
  "use strict";

  // ---------- DOM helpers ----------
  const $ = (s) => document.querySelector(s);
  const el = (tag, props={}) => Object.assign(document.createElement(tag), props);
  const toastEl = $("#toast");
  let toastTimer = null;

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>toastEl.classList.remove("show"), 1400);
  }

  // ---------- Robust shuffle ----------
  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = (Math.random() * (i+1)) | 0;
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  // ---------- Flags ----------
  function flagEmojiFromCCA2(code){
    if(!code || code.length!==2) return "üè≥Ô∏è";
    const A = 0x1F1E6;
    const c0 = code.charCodeAt(0) - 65;
    const c1 = code.charCodeAt(1) - 65;
    if(c0<0 || c0>25 || c1<0 || c1>25) return "üè≥Ô∏è";
    return String.fromCodePoint(A + c0, A + c1);
  }

  // ---------- Canonicalization to prevent confusing duplicates ----------
  function canon(s){
    return String(s)
      .toLowerCase()
      .replace(/\s+/g," ")
      .replace(/[‚Äô']/g,"'")
      .replace(/\(.*?\)/g,"")     // remove parentheticals
      .replace(/[.,]/g,"")        // remove punctuation
      .trim();
  }

  function uniqByCanon(arr){
    const seen = new Set();
    const out = [];
    for(const x of arr){
      const k = canon(x);
      if(!k) continue;
      if(seen.has(k)) continue;
      seen.add(k);
      out.push(x);
    }
    return out;
  }

  // ---------- Government mapping (simple categories like the test) ----------
  // NOTE: We keep it simple on purpose. We only ask GOV for countries we are confident about.
  const GOV = {
    "United States": "Democracy",
    "Canada": "Constitutional Monarchy",
    "United Kingdom": "Constitutional Monarchy",
    "Saudi Arabia": "Absolute Monarchy",
    "Japan": "Constitutional Monarchy",
    "Russia": "Federation",
    "Kenya": "Republic",
    "Germany": "Republic",
    "Mexico": "Republic",
    "Brazil": "Federation",
    "Australia": "Constitutional Monarchy",
    "Spain": "Constitutional Monarchy",
    "Sweden": "Constitutional Monarchy",
    "Norway": "Constitutional Monarchy",
    "Denmark": "Constitutional Monarchy",
    "Netherlands": "Constitutional Monarchy",
    "Belgium": "Constitutional Monarchy",
    "Thailand": "Constitutional Monarchy",
    "China": "Republic",
    "India": "Republic",
    "Egypt": "Republic",
    "South Africa": "Republic",
    "Turkey": "Republic",
    "Nigeria": "Republic",
    "Switzerland": "Democracy",
    "Iraq": "Republic",
    "Portugal": "Republic",
    "Hungary": "Republic",
    "Poland": "Republic",
    "Greece": "Republic",
    "Israel": "Democracy",
    "Vietnam": "Republic",
    "Singapore": "Republic",
    "Ethiopia": "Republic",
    "Ukraine": "Republic",
    "Venezuela": "Republic",
    "Chile": "Republic",
  };

  // ---------- Economy examples (association-based like the test) ----------
  // Only asked when we have a mapping for the country.
  const ECON = {
    "Japan": "Cars and electronics",
    "Brazil": "Coffee and soybeans",
    "Saudi Arabia": "Oil",
    "Kenya": "Tea and coffee farming",
    "Canada": "Timber and oil",
    "India": "IT services and textiles",
    "Egypt": "Tourism and farming",
    "Germany": "Cars and machinery",
    "Mexico": "Oil and cars",
    "Australia": "Minerals and wool",
    "China": "Manufacturing and electronics",
    "South Africa": "Gold and diamonds",
  };

  // ---------- Special capital cases (test-style) ----------
  // Most questions use official capital from dataset.
  // For South Africa, teacher asked specifically: administrative capital = Pretoria.
  const SPECIAL_CAPITAL_Q = {
    "South Africa": { question: "South Africa has three capitals. Which one is the administrative capital?", answer: "Pretoria",
      options: ["Pretoria", "Cape Town", "Bloemfontein", "Johannesburg"] }
  };

  // ---------- Language special cases (teacher style) ----------
  // We adapt some questions to "Only X" traps.
  function languageAnswer(country){
    // We'll prefer official languages list; for some countries, we want the test-like phrasing.
    const n = country.name;
    if(n === "Nigeria") return "English and many local languages";
    // For others, join official languages if multiple
    const langs = country.languages;
    if(langs.length === 0) return "English";
    if(langs.length === 1) return langs[0];
    // Sort for stable text
    return langs.slice().sort((a,b)=>a.localeCompare(b)).join(", ");
  }

  // ---------- Nationality (demonyms) ----------
  function demonymAnswer(country){
    // restcountries has demonyms.eng.m/f; we pick a common neutral/short form.
    // If missing, fall back to "from X" style.
    const d = country.demonym;
    return d || (country.name + " (nationality)");
  }

  // ---------- Data loading ----------
  let ALL = [];      // normalized country objects
  let READY = false;

  async function loadCountries(){
    try{
      const res = await fetch("https://restcountries.com/v3.1/all", { cache: "force-cache" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      const raw = await res.json();

      ALL = raw
        .map(r => {
          const name = r?.name?.common || "";
          const cca2 = (r?.cca2 || "").toUpperCase();
          const capital = Array.isArray(r?.capital) && r.capital.length ? r.capital[0] : "";
          const region = r?.region || "Other";
          const subregion = r?.subregion || "";
          const langsObj = r?.languages || {};
          const languages = Object.values(langsObj).filter(Boolean);
          const dem = r?.demonyms?.eng;
          const demonym = dem?.m || dem?.f || "";
          return {
            name,
            cca2,
            flag: flagEmojiFromCCA2(cca2),
            capital,
            region,
            subregion,
            languages,
            demonym
          };
        })
        .filter(c => c.name && c.cca2 && c.capital) // keep usable entries (capital required for capital questions)
        .sort((a,b)=>a.name.localeCompare(b.name));

      READY = ALL.length >= 100;
      $("#countriesCount").textContent = String(ALL.length);
      $("#datasetStatus").textContent = READY ? "ready" : "partial";
      if(!READY) toast("Dataset loaded partially ‚Äî still playable.");
    }catch(e){
      console.error(e);
      READY = false;
      $("#countriesCount").textContent = "0";
      $("#datasetStatus").textContent = "failed";
      toast("Could not load countries dataset. Check internet.");
    }
  }

  // ---------- Question generation ----------
  const TOPICS = ["FLAG", "CAPITAL", "LANGUAGE", "NATIONALITY", "GOV", "ECONOMY"];

  function pickCountry(filterFn=null){
    if(!ALL.length) return null;
    let tries = 0;
    while(tries++ < 40){
      const c = ALL[(Math.random()*ALL.length)|0];
      if(!filterFn || filterFn(c)) return c;
    }
    return ALL[(Math.random()*ALL.length)|0];
  }

  function sameRegionCandidates(country){
    const reg = country.region;
    const sub = country.subregion;
    // Prefer same subregion, otherwise same region.
    let cands = ALL.filter(x => x.name !== country.name && x.subregion && x.subregion === sub);
    if(cands.length < 10){
      cands = ALL.filter(x => x.name !== country.name && x.region === reg);
    }
    if(cands.length < 10){
      cands = ALL.filter(x => x.name !== country.name);
    }
    return cands;
  }

  function optionsUnique(correct, pool, n){
    const out = [];
    const seen = new Set([canon(correct)]);
    for(const p of shuffle(pool)){
      const k = canon(p);
      if(!k || seen.has(k)) continue;
      seen.add(k);
      out.push(p);
      if(out.length === n) break;
    }
    return out;
  }

  function makeFlagQ(){
    const c = pickCountry();
    const cands = sameRegionCandidates(c);
    const pool = cands.map(x => x.flag);
    const correct = c.flag;
    const opts = shuffle([correct, ...optionsUnique(correct, pool, 3)]);
    return packQ("FLAG", c, `Which is the flag of ${c.name}?`, `Region: ${c.region}${c.subregion ? " ¬∑ " + c.subregion : ""}`, correct, opts);
  }

  function makeCapitalQ(){
    // Special test question
    if(Math.random() < 0.10 && SPECIAL_CAPITAL_Q["South Africa"]){
      const s = SPECIAL_CAPITAL_Q["South Africa"];
      const c = ALL.find(x => x.name === "South Africa") || {name:"South Africa", region:"Africa", flag:"üáøüá¶"};
      const correct = s.answer;
      const opts = shuffle(s.options.slice(0,4));
      return packQ("CAPITAL", c, s.question, `Region: ${c.region}`, correct, opts);
    }

    const c = pickCountry();
    const cands = sameRegionCandidates(c);
    const pool = cands.map(x => x.capital).filter(Boolean);
    const correct = c.capital;
    // make it hard: pick capitals from same region
    const opts = shuffle([correct, ...optionsUnique(correct, pool, 3)]);
    return packQ("CAPITAL", c, `What is the capital of ${c.name}?`, `Region: ${c.region}`, correct, opts);
  }

  function makeLanguageQ(){
    const c = pickCountry();
    const correct = languageAnswer(c);

    // Build distractors: "Only X" traps + nearby languages
    const cands = sameRegionCandidates(c);

    const pool = [];
    // "Only ..." variants
    if(correct.includes(",")){
      const parts = correct.split(",").map(s=>s.trim()).filter(Boolean);
      // common trap: "Only <first>"
      if(parts[0]) pool.push("Only " + parts[0]);
      // "Only English" always shows up as a distractor sometimes
      pool.push("Only English");
      // "Only " + last
      if(parts[parts.length-1]) pool.push("Only " + parts[parts.length-1]);
    } else {
      pool.push("Only " + correct);
      pool.push(correct + " and others");
      pool.push("Only English");
    }

    // Other countries' language answers from same region
    for(const x of cands.slice(0,80)){
      const ans = languageAnswer(x);
      if(ans) pool.push(ans);
    }

    const opts = shuffle([correct, ...optionsUnique(correct, pool, 3)]);
    return packQ("LANGUAGE", c, `What language is spoken in ${c.name}?`, `Main / official language(s)`, correct, opts);
  }

  function makeNationalityQ(){
    const c = pickCountry();
    const correct = demonymAnswer(c);

    // Distractors: similar spellings, plus demonyms from same region
    const cands = sameRegionCandidates(c);
    const pool = [];

    // spelling-like traps (simple rules)
    if(correct){
      pool.push(correct + "n");
      pool.push(correct.replace(/ian$/,"ish"));
      pool.push(correct.replace(/ese$/,"ish"));
      pool.push(correct.replace(/ish$/,"ian"));
      pool.push(correct.replace(/i$/,"ian"));
      pool.push(correct.replace(/an$/,"ian"));
    }

    for(const x of cands.slice(0,120)){
      const d = demonymAnswer(x);
      if(d) pool.push(d);
    }

    const opts = shuffle([correct, ...optionsUnique(correct, pool, 3)]);
    return packQ("NATIONALITY", c, `A person from ${c.name} is:`, `Nationality / demonym`, correct, opts);
  }

  function makeGovQ(){
    // Only ask if we have GOV mapping for the picked country
    const c = pickCountry(x => GOV[x.name]);
    const correct = GOV[c.name];

    const categories = ["Democracy","Republic","Constitutional Monarchy","Absolute Monarchy","Federation","Dictatorship","Empire","Monarchy"];
    // Make distractors plausible: choose close concepts
    let pool = categories.slice();
    // add some tricky but common test distractors
    pool = pool.concat(["Democracy", "Republic", "Dictatorship", "Empire", "Monarchy", "Federation"]);
    pool = uniqByCanon(pool);

    const opts = shuffle([correct, ...optionsUnique(correct, pool, 3)]);
    return packQ("GOV", c, `What type of government does ${c.name} have?`, `Simple categories (as in the test)`, correct, opts);
  }

  function makeEconomyQ(){
    const c = pickCountry(x => ECON[x.name]);
    const correct = ECON[c.name];

    // Distractors are other ECON answers + generic traps
    const pool = Object.values(ECON).filter(v => v !== correct);
    pool.push("Coffee and bananas");
    pool.push("Oil and gas");
    pool.push("Diamonds and gold");
    pool.push("Cars and computers");
    pool.push("Tourism");
    pool.push("Fishing");
    const opts = shuffle([correct, ...optionsUnique(correct, pool, 3)]);
    return packQ("ECONOMY", c, `${c.name} is famous for producing / exporting:`, `Economy example (association-based)`, correct, opts);
  }

  function makeQuestion(){
    // Weighted selection to match typical test emphasis:
    // capitals + language + nationality heavily, flags moderate, gov/econ moderate.
    const weighted = [
      "CAPITAL","CAPITAL","CAPITAL",
      "LANGUAGE","LANGUAGE","LANGUAGE",
      "NATIONALITY","NATIONALITY",
      "FLAG","FLAG",
      "GOV",
      "ECONOMY"
    ];

    let topic = weighted[(Math.random()*weighted.length)|0];

    // If dataset not ready for that topic, fall back
    if(topic === "GOV" && !Object.keys(GOV).length) topic = "CAPITAL";
    if(topic === "ECONOMY" && !Object.keys(ECON).length) topic = "CAPITAL";

    // Generate
    if(topic==="FLAG") return makeFlagQ();
    if(topic==="CAPITAL") return makeCapitalQ();
    if(topic==="LANGUAGE") return makeLanguageQ();
    if(topic==="NATIONALITY") return makeNationalityQ();
    if(topic==="GOV") return makeGovQ();
    return makeEconomyQ();
  }

  function packQ(topic, c, title, meta, correct, options){
    // Ensure 4 options; if not, pad from global pool safely
    let opts = options.filter(Boolean);
    opts = uniqByCanon(opts);
    if(!opts.some(o=>canon(o)===canon(correct))) opts.unshift(correct);
    while(opts.length < 4){
      opts.push("‚Äî");
      opts = uniqByCanon(opts);
    }
    opts = opts.slice(0,4);

    return {
      topic,
      country: c,
      title,
      meta,
      correct,
      options: opts,
    };
  }

  function topicLabel(t){
    const map = {
      FLAG:"Flag",
      CAPITAL:"Capital",
      LANGUAGE:"Language",
      NATIONALITY:"Nationality",
      GOV:"Government",
      ECONOMY:"Economy"
    };
    return map[t] || t;
  }

  // ---------- Game state ----------
  const state = {
    mode: "study",         // study | exam | time
    examTotal: 20,
    examIndex: 0,
    timeLeft: 60,
    timerId: null,

    lifelines: 3,
    locked: false,
    currentQ: null,

    xp: 0,
    streak: 0,
    correct: 0,
    wrong: 0,
    answered: 0,

    misses: [] // {qTitle, correct, chosen, topic, country}
  };

  // ---------- UI wiring ----------
  const menu = $("#menu");
  const game = $("#game");
  const results = $("#results");
  const missList = $("#missList");

  const modeSelect = $("#modeSelect");
  const examCount = $("#examCount");

  const btnStart = $("#btnStart");
  const btnMenu = $("#btnMenu");
  const btnRestart = $("#btnRestart");
  const btnNext = $("#btnNext");
  const btnLifeline = $("#btnLifeline");

  const qTitle = $("#qTitle");
  const qMeta = $("#qMeta");
  const qCountry = $("#qCountry");
  const qTopic = $("#qTopic");
  const answers = $("#answers");
  const hintBox = $("#hintBox");

  const modeLabel = $("#modeLabel");
  const timerBox = $("#timerBox");
  const timerEl = $("#timer");

  const xpEl = $("#xp");
  const streakEl = $("#streak");
  const accEl = $("#acc");
  const correctEl = $("#correct");
  const wrongEl = $("#wrong");
  const lifelineCount = $("#lifelineCount");
  const lifelineLeft = $("#lifelineLeft");
  const examProgPill = $("#examProgPill");
  const examProg = $("#examProg");

  // ---------- Click safety: event delegation ----------
  answers.addEventListener("click", (e) => {
    const btn = e.target.closest(".ans");
    if(!btn) return;
    const idx = Number(btn.dataset.idx);
    if(Number.isNaN(idx)) return;
    choose(idx);
  }, { passive: true });

  // Keyboard shortcuts 1-4
  window.addEventListener("keydown", (e) => {
    const k = e.key;
    if(k >= "1" && k <= "4"){
      const idx = Number(k) - 1;
      const btn = answers.querySelector(`.ans[data-idx="${idx}"]`);
      if(btn) btn.click();
    }
    if(k === "Enter"){
      btnNext.click();
    }
  });

  btnStart.addEventListener("click", () => {
    if(!ALL.length){
      toast("Still loading countries‚Ä¶");
      return;
    }
    const m = modeSelect.value;
    const n = Number(examCount.value) || 20;
    startMode(m, n);
  });

  btnMenu.addEventListener("click", () => {
    showMenu();
  });

  btnRestart.addEventListener("click", () => {
    restartRun();
    toast("Restarted");
  });

  btnNext.addEventListener("click", () => {
    // In Exam, if not answered, don't move (like test discipline)
    if(state.mode === "exam" && !state.locked){
      toast("Pick an answer first");
      return;
    }
    nextQuestion();
  });

  btnLifeline.addEventListener("click", () => {
    useLifeline();
  });

  function showMenu(){
    stopTimer();
    menu.classList.add("show");
    game.classList.remove("show");
    results.style.display = "none";
  }

  function showGame(){
    menu.classList.remove("show");
    game.classList.add("show");
    results.style.display = "none";
  }

  function updateHUD(){
    modeLabel.textContent = state.mode === "study" ? "Study" : (state.mode === "exam" ? "Exam" : "Time Attack");
    xpEl.textContent = String(state.xp);
    streakEl.textContent = String(state.streak);
    correctEl.textContent = String(state.correct);
    wrongEl.textContent = String(state.wrong);
    lifelineCount.textContent = String(state.lifelines);
    lifelineLeft.textContent = String(state.lifelines);

    const total = state.correct + state.wrong;
    const acc = total ? Math.round((state.correct/total)*100) : 0;
    accEl.textContent = total ? (acc + "%") : "‚Äî";

    if(state.mode === "exam"){
      examProgPill.style.display = "inline-flex";
      examProg.textContent = `${Math.min(state.examIndex+1, state.examTotal)}/${state.examTotal}`;
    }else{
      examProgPill.style.display = "none";
    }

    if(state.mode === "time"){
      timerBox.style.display = "block";
      timerEl.textContent = String(state.timeLeft);
      timerEl.style.color = (state.timeLeft <= 10) ? "var(--bad)" : "var(--warn)";
    }else{
      timerBox.style.display = "none";
    }
  }

  function startMode(mode, examN){
    restartRun(); // reset counters
    state.mode = mode;
    state.examTotal = examN;
    state.examIndex = 0;

    // Time settings
    if(mode === "time"){
      state.timeLeft = 60; // pressure
      startTimer();
    }else{
      stopTimer();
    }

    showGame();
    updateHUD();
    nextQuestion(true);
  }

  function restartRun(){
    stopTimer();
    state.lifelines = 3;
    state.locked = false;
    state.currentQ = null;

    state.xp = 0;
    state.streak = 0;
    state.correct = 0;
    state.wrong = 0;
    state.answered = 0;
    state.misses = [];
    state.examIndex = 0;

    answers.innerHTML = "";
    qTitle.textContent = "Ready";
    qMeta.textContent = "";
    qCountry.textContent = "‚Äî";
    qTopic.textContent = "‚Äî";
    hintBox.innerHTML = "<b>Hint</b>: Use Lifeline to remove two wrong options (max 3). Shortcuts: <span class='kbd'>1</span>‚Äì<span class='kbd'>4</span>.";
    results.style.display = "none";
    updateHUD();
  }

  function renderQuestion(q){
    state.currentQ = q;
    state.locked = false;

    qTitle.textContent = q.title;
    qMeta.textContent = q.meta;
    qCountry.textContent = `${q.country.flag} ${q.country.name}`;
    qTopic.textContent = topicLabel(q.topic);

    // Render answers as BUTTONS (more reliable click semantics)
    answers.innerHTML = "";
    q.options.forEach((opt, i) => {
      const b = el("button", { className: "ans", type: "button" });
      b.dataset.idx = String(i);
      b.textContent = opt;
      b.setAttribute("aria-disabled", "false");
      answers.appendChild(b);
    });

    // In Time Attack, allow next even if not answered (but better to answer)
    btnNext.disabled = false;

    // Update exam progress display
    updateHUD();
  }

  function markCorrectWrong(chosenText){
    const q = state.currentQ;
    const nodes = [...answers.querySelectorAll(".ans")];
    for(const node of nodes){
      const text = node.textContent;
      if(canon(text) === canon(q.correct)) node.classList.add("correct");
      if(canon(text) === canon(chosenText) && canon(text) !== canon(q.correct)) node.classList.add("wrong");
      node.setAttribute("aria-disabled","true");
    }
  }

  function choose(idx){
    if(state.locked) return;
    const q = state.currentQ;
    if(!q) return;

    const nodes = [...answers.querySelectorAll(".ans")];
    const btn = nodes[idx];
    if(!btn) return;

    const chosen = btn.textContent;

    state.locked = true;
    state.answered += 1;

    const ok = (canon(chosen) === canon(q.correct));

    markCorrectWrong(chosen);

    if(ok){
      state.correct += 1;
      state.streak += 1;
      // XP: base + streak bonus
      const gain = 10 + Math.min(20, state.streak);
      state.xp += gain;
      toast("Correct +" + gain + " XP");
    }else{
      state.wrong += 1;
      state.streak = 0;
      state.misses.push({
        qTitle: q.title,
        correct: q.correct,
        chosen,
        topic: topicLabel(q.topic),
        country: q.country.name
      });
      toast("Wrong");
    }

    // In Time Attack, we keep the flow: next still required but works.
    updateHUD();

    // Auto-finish exam if reached total
    if(state.mode === "exam"){
      // examIndex increments when question is generated; here we just check if final answered will end.
      if(state.examIndex >= state.examTotal){
        // safe guard
      }
    }
  }

  function useLifeline(){
    if(!state.currentQ) return;
    if(state.lifelines <= 0){
      toast("No lifelines left");
      return;
    }
    if(state.locked){
      toast("Use lifeline before answering");
      return;
    }

    const q = state.currentQ;
    const nodes = [...answers.querySelectorAll(".ans")];
    // collect wrong option indices
    const wrongIdx = nodes
      .map((n,i)=>({i, t:n.textContent}))
      .filter(x => canon(x.t) !== canon(q.correct))
      .map(x=>x.i);

    if(wrongIdx.length <= 2){
      toast("Nothing to remove");
      return;
    }

    // remove 2 wrong options (disable + fade)
    const toRemove = shuffle(wrongIdx).slice(0,2);
    for(const i of toRemove){
      const b = nodes[i];
      b.setAttribute("aria-disabled","true");
      b.disabled = true;
      b.style.opacity = "0.25";
      b.style.filter = "grayscale(0.6)";
    }

    state.lifelines -= 1;
    updateHUD();
    toast("Lifeline used");
  }

  function nextQuestion(isFirst=false){
    // Exam end condition: after answering examTotal questions, show results
    if(state.mode === "exam"){
      if(!isFirst && state.examIndex >= state.examTotal){
        showExamResults();
        return;
      }
    }

    // Time Attack end condition
    if(state.mode === "time" && state.timeLeft <= 0){
      showTimeResults();
      return;
    }

    const q = makeQuestion();
    if(!q){
      toast("No question available");
      return;
    }

    // In exam, increment index when we show a new question
    if(state.mode === "exam"){
      state.examIndex = Math.min(state.examIndex + 1, state.examTotal);
    }

    renderQuestion(q);

    // For exam, update progress after render
    updateHUD();
  }

  function showExamResults(){
    stopTimer();
    results.style.display = "block";

    const total = state.examTotal;
    const score = total ? Math.round((state.correct / total) * 100) : 0;
    $("#finalScore").textContent = `Score: ${score}/100`;
    $("#finalMeta").textContent = `Correct: ${state.correct} ¬∑ Wrong: ${state.wrong} ¬∑ XP earned: ${state.xp} ¬∑ Lifelines used: ${3 - state.lifelines}`;

    missList.innerHTML = "";
    if(state.misses.length === 0){
      missList.appendChild(el("div",{className:"missItem", innerHTML:`<div class="t">Perfect run ‚úÖ</div><div class="m">No mistakes.</div>`}));
    }else{
      for(const m of state.misses.slice(0,50)){
        const item = el("div",{className:"missItem"});
        item.innerHTML = `<div class="t">${m.topic} ‚Äî ${m.country}</div>
          <div class="m"><b>Q:</b> ${escapeHtml(m.qTitle)}<br/>
          <b>Your answer:</b> ${escapeHtml(m.chosen)}<br/>
          <b>Correct:</b> ${escapeHtml(m.correct)}</div>`;
        missList.appendChild(item);
      }
    }
    toast("Exam finished");
  }

  function showTimeResults(){
    stopTimer();
    results.style.display = "block";
    const total = state.correct + state.wrong;
    const acc = total ? Math.round((state.correct/total)*100) : 0;
    $("#finalScore").textContent = `Time Attack ‚Äî XP: ${state.xp}`;
    $("#finalMeta").textContent = `Answered: ${total} ¬∑ Correct: ${state.correct} ¬∑ Wrong: ${state.wrong} ¬∑ Accuracy: ${acc}%`;
    missList.innerHTML = "";
    if(state.misses.length){
      missList.appendChild(el("div",{className:"missItem", innerHTML:`<div class="t">Top mistakes (sample)</div><div class="m">Review the ones you missed most.</div>`}));
      for(const m of state.misses.slice(0,12)){
        const item = el("div",{className:"missItem"});
        item.innerHTML = `<div class="t">${m.topic} ‚Äî ${m.country}</div>
          <div class="m"><b>Correct:</b> ${escapeHtml(m.correct)} ¬∑ <b>You:</b> ${escapeHtml(m.chosen)}</div>`;
        missList.appendChild(item);
      }
    }else{
      missList.appendChild(el("div",{className:"missItem", innerHTML:`<div class="t">Nice ‚úÖ</div><div class="m">No recorded mistakes.</div>`}));
    }
    toast("Time Attack ended");
  }

  function startTimer(){
    stopTimer();
    state.timeLeft = 60;
    updateHUD();

    state.timerId = setInterval(() => {
      state.timeLeft -= 1;
      if(state.timeLeft < 0) state.timeLeft = 0;
      updateHUD();

      // Pressure FX: pulse title when <=10
      if(state.timeLeft <= 10){
        qTitle.style.transform = "scale(1.01)";
        setTimeout(()=>qTitle.style.transform="scale(1)", 80);
      }

      if(state.timeLeft <= 0){
        showTimeResults();
      }
    }, 1000);
  }

  function stopTimer(){
    if(state.timerId){
      clearInterval(state.timerId);
      state.timerId = null;
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // ---------- Init ----------
  (async function init(){
    restartRun();
    showMenu();
    await loadCountries();
    // If still not ready, keep app usable but warn
    if(ALL.length >= 100){
      toast("Countries loaded");
    }else{
      toast("Countries dataset incomplete");
    }
  })();

})();
</script>
</body>
</html>
